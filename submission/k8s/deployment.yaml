# deployment.yaml â€” Video Processing Service Deployment
#
# TASK: Complete this deployment manifest for a production video processing service.
#
# Requirements:
#   - Resource requests and limits (CPU + memory)
#   - Liveness and readiness probes
#   - Security context (non-root, read-only root filesystem)
#   - Anti-affinity or topology spread constraints
#   - Image tag should NOT be :latest
#   - Reference the ConfigMap you create in configmap.yaml
#   - Environment variables for service configuration

apiVersion: apps/v1
kind: Deployment
metadata:
  name: video-processor
  namespace: video-analytics
  labels:
    app: video-processor
spec:
  replicas: 3
  selector:
    matchLabels:
      app: video-processor
  template:
    metadata:
      labels:
        app: video-processor
    spec:
      # --- Pod-level Security Context ---
      # Enforce non-root execution at the pod level; containers inherit unless overridden
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault

      # --- Topology Spread Constraints ---
      # Spread pods across nodes and AZs to avoid a single node/AZ outage
      # taking down multiple replicas simultaneously
      topologySpreadConstraints:
        - maxSkew: 1
          topologyKey: kubernetes.io/hostname
          whenUnsatisfiable: DoNotSchedule
          labelSelector:
            matchLabels:
              app: video-processor
        - maxSkew: 1
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: DoNotSchedule
          labelSelector:
            matchLabels:
              app: video-processor

      # --- Node Affinity ---
      # Target the general/video-processing node groups; avoid GPU nodes
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: role
                    operator: In
                    values:
                      - video-processing
                      - general
    spec:
      containers:
      - name: video-processor
        image: 123456789012.dkr.ecr.us-east-1.amazonaws.com/video-processor:1.4.2 # FIXED: Set image with a specific tag (not :latest)
        ports:
        - containerPort: 8080
          name: http
        # --- Resource Requests and Limits ---
          # Requests sized for the c5/m5 node groups identified in the cost report.
          # Limits cap runaway processes without OOMKilling neighbours.
        resources:
          requests:
            cpu: "1"
            memory: "1Gi"
          limits:
            cpu: "2"
            memory: "2Gi"
         # --- Liveness Probe ---
          # Restarts the container if the service is deadlocked or unresponsive.
          # initialDelaySeconds gives Kafka consumer group rebalancing time to complete on startup.
        livenessProbe:
          httpGet:
            path: /healthz
            port: http
          initialDelaySeconds: 30
          periodSeconds: 15
          failureThreshold: 3
          timeoutSeconds: 5

          # --- Readiness Probe ---
          # Removes the pod from Service endpoints until it has connected to Kafka
          # and is ready to process frames. Shorter period than liveness for faster
          # traffic recovery after a restart.
        readinessProbe:
          httpGet:
            path: /ready
            port: http
          initialDelaySeconds: 15
          periodSeconds: 10
          failureThreshold: 3
          timeoutSeconds: 3

          # --- Container-level Security Context ---
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
              - ALL

          # --- Environment Variables ---
          # Static config from ConfigMap; secrets should come from Secrets Manager
          # via the AWS Secrets Store CSI driver (not plain env vars)
        env:
          - name: KAFKA_BOOTSTRAP_SERVERS
            valueFrom:
              configMapKeyRef:
                name: video-processor-config
                key: KAFKA_BOOTSTRAP_SERVERS
          - name: KAFKA_CONSUMER_GROUP
            valueFrom:
              configMapKeyRef:
                name: video-processor-config
                key: KAFKA_CONSUMER_GROUP
          - name: S3_VIDEO_BUCKET
            valueFrom:
              configMapKeyRef:
                name: video-processor-config
                key: S3_VIDEO_BUCKET
          - name: AWS_REGION
            valueFrom:
              configMapKeyRef:
                name: video-processor-config
                key: AWS_REGION
          - name: LOG_LEVEL
            valueFrom:
              configMapKeyRef:
                name: video-processor-config
                key: LOG_LEVEL
          - name: CHUNK_DURATION_SECONDS
            valueFrom:
              configMapKeyRef:
                name: video-processor-config
                key: CHUNK_DURATION_SECONDS

          # --- Volume Mounts ---
          # Writable scratch space for temp video chunks (root filesystem is read-only)
        volumeMounts:
          - name: tmp
            mountPath: /tmp
          - name: video-scratch
            mountPath: /var/video-scratch

      # --- Volumes ---
      volumes:
        - name: tmp
          emptyDir: {}
        - name: video-scratch
          emptyDir:
            sizeLimit: 10Gi  # Bounded scratch space per pod; sized for ~2-5 Mbps x 32 cameras burst
        # TODO: Add resource requests and limits
        # TODO: Add liveness probe
        # TODO: Add readiness probe
        # TODO: Add security context
        # TODO: Add environment variables (reference ConfigMap)
      # TODO: Add pod-level security context
      # TODO: Add anti-affinity or topology spread constraints
